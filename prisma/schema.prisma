// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                    Int          @id @default(autoincrement())
  email                 String       @unique
  name                  String
  password              String
  role                  Role         @default(USER)
  phone                 String?
  avatar                String?
  vehicleType           VehicleType? // CAR, TAXI, VAN
  vehicleRegistration   String?      // Vehicle registration number
  resetPasswordToken    String?
  resetPasswordExpires  DateTime?
  stripeCustomerId      String?      @unique
  fcmToken              String?      // Firebase Cloud Messaging Token
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt
  status                UserStatus   @default(ACTIVE)

  subscriptions    Subscription[]
  paymentMethods   PaymentMethod[]
  supportTickets   SupportTicket[]
  verifications    Verification[]
  oneTimePurchases OneTimePurchase[]

  @@map("users")
}

model ExtraService {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  price       Float
  type        WashType // IN_AND_OUT or OUTSIDE_ONLY
  active      Boolean  @default(true)
  deleted     Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  purchases   OneTimePurchase[]

  @@map("extra_services")
}

model OneTimePurchase {
  id             Int             @id @default(autoincrement())
  userId         Int
  serviceId      Int
  status         PurchaseStatus  @default(PENDING)
  stripePaymentIntentId String?  @unique
  used           Boolean         @default(false)
  usedAt         DateTime?
  expiresAt      DateTime?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  user           User            @relation(fields: [userId], references: [id])
  service        ExtraService    @relation(fields: [serviceId], references: [id])
  qrCode         QRCode?
  verification   Verification?
  verificationCodes VerificationCode[]

  @@map("one_time_purchases")
}

enum PurchaseStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

model Plan {
  id                  Int          @id @default(autoincrement())
  name                String
  description         String?
  price               Float
  duration            Int          // in days
  vehicleType         VehicleType? // CAR, TAXI, VAN (optional for migration)
  tier                PlanTier?    // BASE, STANDARD, PREMIUM (optional for migration)
  inAndOutQuota       Int?         // Number of In & Out washes allowed
  outsideOnlyQuota    Int?         // Number of Outside Only washes allowed (mainly for BASE plans)
  inAndOutPayout      Float?       // Payout amount per In & Out wash (e.g., 10.00 for £10)
  outsideOnlyPayout   Float?       // Payout amount per Outside Only wash (e.g., 8.00 for £8)
  active              Boolean      @default(true)
  deleted             Boolean      @default(false)
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt

  subscriptions Subscription[]

  @@map("plans")
}

model Subscription {
  id                   Int                @id @default(autoincrement())
  userId               Int
  planId               Int
  status               SubscriptionStatus @default(PENDING)
  startDate            DateTime
  endDate              DateTime
  inAndOutWashesUsed   Int                @default(0) // Track In & Out washes separately
  outsideOnlyWashesUsed Int               @default(0) // Track Outside Only washes separately
  stripeSubscriptionId String?            @unique
  cancelAtPeriodEnd    Boolean            @default(false)
  canceledAt           DateTime?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan              Plan               @relation(fields: [planId], references: [id])
  qrCodes           QRCode[]
  verifications     Verification[]
  invoices          Invoice[]
  verificationCodes VerificationCode[]

  @@map("subscriptions")
}

model Partner {
  id                        Int           @id @default(autoincrement())
  name                      String        // Business Name
  tradingName               String?       // Trading Name (optional)
  companyRegistrationNumber String?       // CRN (optional)
  contactPersonName         String?       // Contact person name
  email                     String        @unique
  password                  String        // Hashed password
  phone                     String?       
  openingHours              String?       // JSON string or text format
  servicesOffered           String?       // JSON array or comma-separated
  businessPhoto             String?       // URL to uploaded photo/logo
  resetPasswordToken        String?
  resetPasswordExpires      DateTime?
  status                    PartnerStatus @default(PENDING)
  stripeAccountId           String?       @unique // Stripe Connect account ID for payouts
  fcmToken                  String?       // Firebase Cloud Messaging Token
  createdAt                 DateTime      @default(now())
  updatedAt                 DateTime      @updatedAt

  locations     Location[]
  verifications Verification[]
  payouts       Payout[]

  @@map("partners")
}

model Location {
  id           Int      @id @default(autoincrement())
  partnerId    Int
  name         String   // Location/Branch name (e.g., "Main Office", "Downtown Branch")
  postcode     String?  // UK Postcode - Nullable for legacy data
  addressLine1 String?  // e.g., "123 High Street" - Nullable for legacy data
  addressLine2 String?  // e.g., "Suite 4" - OPTIONAL
  city         String?  // e.g., "London" - Nullable for legacy data
  county       String?  // e.g., "Greater London" - Auto-filled from postcode
  country      String   @default("United Kingdom")
  latitude     Float    // Precise coordinates from postcode validation
  longitude    Float    // Precise coordinates from postcode validation
  phone        String?  // Location-specific phone
  hours        String?  // Location-specific opening hours
  isPrimary    Boolean  @default(false) // Mark primary business location
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  partner       Partner        @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  verifications Verification[]

  @@index([partnerId])
  @@index([postcode])
  @@index([isPrimary])
  @@map("locations")
}

model Verification {
  id             Int       @id @default(autoincrement())
  userId         Int
  partnerId      Int
  subscriptionId Int?
  locationId     Int?
  washType       WashType? // IN_AND_OUT or OUTSIDE_ONLY (optional for migration)
  payoutAmount   Float?    // The payout amount for this specific wash (optional for migration)
  verifiedAt     DateTime  @default(now())
  createdAt      DateTime  @default(now())

  user         User          @relation(fields: [userId], references: [id])
  partner      Partner       @relation(fields: [partnerId], references: [id])
  subscription Subscription? @relation(fields: [subscriptionId], references: [id])
  location     Location?     @relation(fields: [locationId], references: [id])
  payout       Payout?       // One-to-one relation with Payout
  
  // Relations for One-Time Purchases
  oneTimePurchaseId Int?     @unique
  oneTimePurchase   OneTimePurchase? @relation(fields: [oneTimePurchaseId], references: [id])

  @@map("verifications")
}

model QRCode {
  id             Int       @id @default(autoincrement())
  subscriptionId Int?
  oneTimePurchaseId Int?   @unique
  code           String    @unique
  washType       WashType? // IN_AND_OUT or OUTSIDE_ONLY (optional for migration)
  active         Boolean   @default(true)
  expiresAt      DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  subscription    Subscription?    @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  oneTimePurchase OneTimePurchase? @relation(fields: [oneTimePurchaseId], references: [id])

  @@map("qr_codes")
}

model VerificationCode {
  id             Int                @id @default(autoincrement())
  subscriptionId Int?
  oneTimePurchaseId Int?
  code           String             @unique
  qrCodeData     String             // Base64 or data URL for QR code
  washType       WashType?          // IN_AND_OUT or OUTSIDE_ONLY (optional for migration)
  status         VerificationStatus @default(PENDING)
  usedBy         Int?               // Partner ID who used it
  usedAt         DateTime?
  startedAt      DateTime?
  completedAt    DateTime?
  expiresAt      DateTime
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  subscription    Subscription?    @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  oneTimePurchase OneTimePurchase? @relation(fields: [oneTimePurchaseId], references: [id])

  @@index([code])
  @@index([subscriptionId])
  @@index([status])
  @@map("verification_codes")
}

enum VerificationStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  EXPIRED
  CANCELLED
}

model PaymentMethod {
  id                     Int      @id @default(autoincrement())
  userId                 Int
  stripePaymentMethodId  String   @unique
  type                   String
  last4                  String?
  brand                  String?
  expiryMonth            Int?
  expiryYear             Int?
  isDefault              Boolean  @default(false)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("payment_methods")
}

model Invoice {
  id                Int           @id @default(autoincrement())
  subscriptionId    Int
  stripeInvoiceId   String        @unique
  amount            Float
  status            InvoiceStatus @default(PENDING)
  dueDate           DateTime
  paidAt            DateTime?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  subscription   Subscription? @relation(fields: [subscriptionId], references: [id])
  
  @@map("invoices")
}

model SupportTicket {
  id        Int                 @id @default(autoincrement())
  userId    Int
  subject   String
  message   String
  status    SupportTicketStatus @default(OPEN)
  priority  Priority            @default(NORMAL)
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@map("support_tickets")
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum Role {
  USER
  PARTNER
  ADMIN
}

enum SubscriptionStatus {
  PENDING
  ACTIVE
  EXPIRED
  CANCELLED
}

enum PartnerStatus {
  PENDING
  ACTIVE
  REJECTED
  INACTIVE
}

enum InvoiceStatus {
  PENDING
  PAID
  FAILED
}

enum SupportTicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

model SystemSetting {
  key         String   @id
  value       String
  description String?
  updatedAt   DateTime @updatedAt

  @@map("system_settings")
}

enum Priority {
  LOW
  NORMAL
  HIGH
}

enum WashType {
  IN_AND_OUT
  OUTSIDE_ONLY
}

enum VehicleType {
  CAR
  TAXI
  VAN
}

enum PlanTier {
  BASE
  STANDARD
  PREMIUM
}

model Payout {
  id                Int           @id @default(autoincrement())
  partnerId         Int
  verificationId    Int?          @unique // Link to the verification that triggered this payout
  amount            Float         // Amount in pounds (e.g., 2.00)
  currency          String        @default("GBP")
  status            PayoutStatus  @default(PENDING)
  stripeTransferId  String?       @unique // Stripe Transfer ID
  stripePayoutId    String?       // Stripe Payout ID (when funds reach bank)
  failureReason     String?       // If payout failed
  description       String?
  metadata          Json?         // Additional metadata
  scheduledFor      DateTime?     // When payout should be processed
  processedAt       DateTime?     // When payout was actually processed
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  partner       Partner       @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  verification  Verification? @relation(fields: [verificationId], references: [id])

  @@index([partnerId])
  @@index([status])
  @@index([createdAt])
  @@map("payouts")
}

enum PayoutStatus {
  PENDING     // Payout created, waiting to be processed
  PROCESSING  // Being processed by Stripe
  PAID        // Successfully paid out
  FAILED      // Failed to process
  CANCELLED   // Cancelled before processing
}