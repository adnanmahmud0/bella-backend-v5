generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   Int               @id @default(autoincrement())
  email                String            @unique
  name                 String
  password             String
  role                 Role              @default(USER)
  phone                String?
  avatar               String?
  stripeCustomerId     String?           @unique
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt
  vehicleRegistration  String?
  vehicleType          VehicleType?
  resetPasswordExpires DateTime?
  resetPasswordToken   String?
  status               UserStatus        @default(ACTIVE)
  fcmToken             String?
  oneTimePurchases     OneTimePurchase[]
  paymentMethods       PaymentMethod[]
  subscriptions        Subscription[]
  supportTickets       SupportTicket[]
  verifications        Verification[]

  @@map("users")
}

model ExtraService {
  id          Int               @id @default(autoincrement())
  name        String
  description String?
  price       Float
  type        WashType
  active      Boolean           @default(true)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  deleted     Boolean           @default(false)
  purchases   OneTimePurchase[]

  @@map("extra_services")
}

model OneTimePurchase {
  id                    Int                @id @default(autoincrement())
  userId                Int
  serviceId             Int
  status                PurchaseStatus     @default(PENDING)
  stripePaymentIntentId String?            @unique
  used                  Boolean            @default(false)
  usedAt                DateTime?
  expiresAt             DateTime?
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  service               ExtraService       @relation(fields: [serviceId], references: [id])
  user                  User               @relation(fields: [userId], references: [id])
  qrCode                QRCode?
  verificationCodes     VerificationCode[]
  verification          Verification?

  @@map("one_time_purchases")
}

model Plan {
  id                Int            @id @default(autoincrement())
  name              String
  description       String?
  price             Float
  duration          Int
  active            Boolean        @default(true)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  inAndOutPayout    Float?
  inAndOutQuota     Int?
  outsideOnlyPayout Float?
  outsideOnlyQuota  Int?
  tier              PlanTier?
  vehicleType       VehicleType?
  deleted           Boolean        @default(false)
  subscriptions     Subscription[]

  @@map("plans")
}

model Subscription {
  id                    Int                @id @default(autoincrement())
  userId                Int
  planId                Int
  status                SubscriptionStatus @default(PENDING)
  startDate             DateTime
  endDate               DateTime
  stripeSubscriptionId  String?            @unique
  cancelAtPeriodEnd     Boolean            @default(false)
  canceledAt            DateTime?
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  inAndOutWashesUsed    Int                @default(0)
  outsideOnlyWashesUsed Int                @default(0)
  invoices              Invoice[]
  qrCodes               QRCode[]
  plan                  Plan               @relation(fields: [planId], references: [id])
  user                  User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  verificationCodes     VerificationCode[]
  verifications         Verification[]

  @@map("subscriptions")
}

model Partner {
  id                        Int            @id @default(autoincrement())
  name                      String
  email                     String         @unique
  password                  String
  phone                     String?
  status                    PartnerStatus  @default(PENDING)
  stripeAccountId           String?        @unique
  createdAt                 DateTime       @default(now())
  updatedAt                 DateTime       @updatedAt
  businessPhoto             String?
  companyRegistrationNumber String?
  contactPersonName         String?
  openingHours              String?
  servicesOffered           String?
  tradingName               String?
  resetPasswordExpires      DateTime?
  resetPasswordToken        String?
  fcmToken                  String?
  locations                 Location[]
  payouts                   Payout[]
  verifications             Verification[]

  @@map("partners")
}

model Location {
  id            Int            @id @default(autoincrement())
  partnerId     Int
  name          String
  latitude      Float
  longitude     Float
  phone         String?
  hours         String?
  active        Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  addressLine1  String?
  addressLine2  String?
  city          String?
  country       String         @default("United Kingdom")
  county        String?
  postcode      String?
  isPrimary     Boolean        @default(false)
  partner       Partner        @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  verifications Verification[]

  @@index([partnerId])
  @@index([postcode])
  @@index([isPrimary])
  @@map("locations")
}

model Verification {
  id                Int              @id @default(autoincrement())
  userId            Int
  partnerId         Int
  subscriptionId    Int?
  locationId        Int?
  verifiedAt        DateTime         @default(now())
  createdAt         DateTime         @default(now())
  payoutAmount      Float?
  washType          WashType?
  oneTimePurchaseId Int?             @unique
  payout            Payout?
  location          Location?        @relation(fields: [locationId], references: [id])
  oneTimePurchase   OneTimePurchase? @relation(fields: [oneTimePurchaseId], references: [id])
  partner           Partner          @relation(fields: [partnerId], references: [id])
  subscription      Subscription?    @relation(fields: [subscriptionId], references: [id])
  user              User             @relation(fields: [userId], references: [id])

  @@map("verifications")
}

model QRCode {
  id                Int              @id @default(autoincrement())
  subscriptionId    Int?
  code              String           @unique
  active            Boolean          @default(true)
  expiresAt         DateTime?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  washType          WashType?
  oneTimePurchaseId Int?             @unique
  oneTimePurchase   OneTimePurchase? @relation(fields: [oneTimePurchaseId], references: [id])
  subscription      Subscription?    @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@map("qr_codes")
}

model VerificationCode {
  id                Int                @id @default(autoincrement())
  subscriptionId    Int?
  code              String             @unique
  qrCodeData        String
  status            VerificationStatus @default(PENDING)
  usedBy            Int?
  usedAt            DateTime?
  startedAt         DateTime?
  completedAt       DateTime?
  expiresAt         DateTime
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  washType          WashType?
  oneTimePurchaseId Int?
  oneTimePurchase   OneTimePurchase?   @relation(fields: [oneTimePurchaseId], references: [id])
  subscription      Subscription?      @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([code])
  @@index([subscriptionId])
  @@index([status])
  @@map("verification_codes")
}

model PaymentMethod {
  id                    Int      @id @default(autoincrement())
  userId                Int
  stripePaymentMethodId String   @unique
  type                  String
  last4                 String?
  brand                 String?
  expiryMonth           Int?
  expiryYear            Int?
  isDefault             Boolean  @default(false)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("payment_methods")
}

model Invoice {
  id              Int           @id @default(autoincrement())
  subscriptionId  Int
  stripeInvoiceId String        @unique
  amount          Float
  status          InvoiceStatus @default(PENDING)
  dueDate         DateTime
  paidAt          DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  subscription    Subscription  @relation(fields: [subscriptionId], references: [id])

  @@map("invoices")
}

model SupportTicket {
  id        Int                 @id @default(autoincrement())
  userId    Int
  subject   String
  message   String
  status    SupportTicketStatus @default(OPEN)
  priority  Priority            @default(NORMAL)
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt
  user      User                @relation(fields: [userId], references: [id])

  @@map("support_tickets")
}

model SystemSetting {
  key         String   @id
  value       String
  description String?
  updatedAt   DateTime @updatedAt

  @@map("system_settings")
}

model Payout {
  id               Int           @id @default(autoincrement())
  partnerId        Int
  verificationId   Int?          @unique
  amount           Float
  currency         String        @default("GBP")
  status           PayoutStatus  @default(PENDING)
  stripeTransferId String?       @unique
  stripePayoutId   String?
  failureReason    String?
  description      String?
  metadata         Json?
  scheduledFor     DateTime?
  processedAt      DateTime?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  partner          Partner       @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  verification     Verification? @relation(fields: [verificationId], references: [id])

  @@index([partnerId])
  @@index([status])
  @@index([createdAt])
  @@map("payouts")
}

enum PurchaseStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum VerificationStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  EXPIRED
  CANCELLED
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum Role {
  USER
  PARTNER
  ADMIN
}

enum SubscriptionStatus {
  PENDING
  ACTIVE
  EXPIRED
  CANCELLED
}

enum PartnerStatus {
  ACTIVE
  INACTIVE
  PENDING
  REJECTED
}

enum InvoiceStatus {
  PENDING
  PAID
  FAILED
}

enum SupportTicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum Priority {
  LOW
  NORMAL
  HIGH
}

enum WashType {
  IN_AND_OUT
  OUTSIDE_ONLY
}

enum VehicleType {
  CAR
  TAXI
  VAN
}

enum PlanTier {
  BASE
  STANDARD
  PREMIUM
}

enum PayoutStatus {
  PENDING
  PROCESSING
  PAID
  FAILED
  CANCELLED
}
